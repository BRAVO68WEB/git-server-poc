services:
  nginx:
    image: nginx:alpine
    container_name: githut-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deploy/nginx.conf:/etc/nginx/nginx.conf:ro
      - nginx_certs:/etc/nginx/certs
    depends_on:
      api:
        condition: service_healthy
      web:
        condition: service_started
    restart: unless-stopped

  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: githut-api
    expose:
      - "8080"
    # healthcheck:
    #   test: ["CMD", "wget", "-qO-", "http://localhost:8080/"]
    #   interval: 10s
    #   timeout: 3s
    #   retries: 5
    #   start_period: 10s
    environment:
      - CONFIG_PATH=/app/configs/config.yaml
      - GITSERVER_DATABASE_HOST=postgres
      - GITSERVER_DATABASE_PORT=5432
      - GITSERVER_DATABASE_USER=githut
      - GITSERVER_DB_PASSWORD=githut
      - GITSERVER_DATABASE_DBNAME=githut
      - GITSERVER_DATABASE_SSLMODE=disable
      - GITSERVER_SERVER_HOST=0.0.0.0
      - GITSERVER_SERVER_PORT=8080
      - GITSERVER_SSH_HOST=0.0.0.0
      - GITSERVER_SSH_PORT=2222
      - GITSERVER_STORAGE_TYPE=filesystem
      - GITSERVER_STORAGE_BASE_PATH=/app/data/repos
      - GITSERVER_OIDC_FRONTEND_URL=http://localhost
    depends_on:
      - postgres
        # condition: service_healthy
    ports:
      - "2222:2222"
    volumes:
      - repo_data:/app/data/repos
      - ./configs/config.yaml:/app/configs/config.yaml:ro
    restart: unless-stopped
    env_file:
      - configs/.env
    develop:
      watch:
        - action: rebuild
          path: ./cmd
        - action: rebuild
          path: ./internal
        - action: rebuild
          path: ./pkg
        - action: rebuild
          path: ./go.mod
        - action: sync+restart
          path: ./configs
          target: /app/configs

  web:
    build:
      context: .
      dockerfile: Dockerfile.web
      args:
        - NEXT_PUBLIC_API_URL=http://localhost/api
        - STASIS_SERVER_HOSTED_URL=http://localhost
        - STASIS_SSH_HOST_NAME=localhost:2222
    container_name: githut-web
    expose:
      - "3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost/api
      - STASIS_SERVER_HOSTED_URL=http://localhost
      - STASIS_SSH_HOST_NAME=localhost:2222
      - DOCKER_ENV=true
    depends_on:
      - api
    restart: unless-stopped
    develop:
      watch:
        - action: rebuild
          path: ./web/**/*.{ts,tsx,js,jsx,json}

  postgres:
    image: postgres:17-alpine
    container_name: githut-postgres
    environment:
      POSTGRES_USER: githut
      POSTGRES_PASSWORD: githut
      POSTGRES_DB: githut
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    # healthcheck:
    #   test: ["CMD-SHELL", "pg_isready -U githut"]
    #   interval: 5s
    #   timeout: 5s
    #   retries: 5
    restart: unless-stopped

volumes:
  postgres_data:
  repo_data:
  nginx_certs:

networks:
  githut-network:
    driver: bridge
    name: githut-network
